#!/usr/bin/env coffee

tilestrata = require 'tilestrata'
tileStrataMapnik = require 'tilestrata-mapnik'
{sql} = require 'naukluft-db'
{join} = require 'path'
mapnik = require 'mapnik'
mapnik.register_default_fonts()
mapnik.register_default_input_plugins()
{writeFileSync} = require 'fs'

{MapStyle, PostGISLayer} = require 'carto-map-style'

style = new MapStyle
  srs: "+init=epsg:3857",
  layers: [
    new PostGISLayer "terrain", sql('tile-layer'), dbname: 'Naukluft'
  ]
  styles: [
    require.resolve("./cross-section.mss")
  ]

xml = style.toXml()

setupServer = (port=39805)->
  # Requires a mapping of layers
  strata = tilestrata()

  # URL http://localhost:39805/geology/0/0/0/tile@2x.png
  strata
    .layer("geology")
      .route 'tile@2x.png'
      .use tileStrataMapnik {xml, pathname: "style.xml", tileSize: 512, scale: 2 }

  return strata

strata = setupServer()
strata.listen(39805)

process.on 'SIGINT', -> console.log 'SIGINT'; process.exit 0
process.on 'SIGTERM', -> console.log 'SIGTERM'; process.exit 0

